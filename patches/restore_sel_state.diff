Index: tools/kptoolclear.cpp
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolclear.cpp,v
retrieving revision 1.6
diff -u -p -b -r1.6 kptoolclear.cpp
--- tools/kptoolclear.cpp	2 Feb 2004 03:00:08 -0000	1.6
+++ tools/kptoolclear.cpp	24 Feb 2004 05:18:55 -0000
@@ -89,6 +89,9 @@ void kpToolClearCommand::execute ()
 
     if (m_actOnSelection)
     {
+        m_oldSelection = *doc->selection ();
+        m_oldSelection.setPixmap (QPixmap ());
+
         // OPT: could just edit pixmap directly and signal change
         kpSelection *sel = doc->selection ();
 
@@ -114,9 +117,16 @@ void kpToolClearCommand::unexecute ()
         return;
     }
 
-
-    doc->setPixmap (m_actOnSelection, *m_oldPixmapPtr);
-
+    if (!m_actOnSelection)
+    {
+        doc->setPixmap (*m_oldPixmapPtr);
+    }
+    else
+    {
+        kpSelection sel = m_oldSelection;
+        sel.setPixmap (*m_oldPixmapPtr);
+        doc->setSelection (sel);
+    }
 
     delete m_oldPixmapPtr;
     m_oldPixmapPtr = 0;
Index: tools/kptoolclear.h
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolclear.h,v
retrieving revision 1.4
diff -u -p -b -r1.4 kptoolclear.h
--- tools/kptoolclear.h	21 Jan 2004 12:26:14 -0000	1.4
+++ tools/kptoolclear.h	24 Feb 2004 05:18:55 -0000
@@ -32,6 +32,7 @@
 #include <kcommand.h>
 
 #include <kpcolor.h>
+#include <kpselection.h>
 
 class QPixmap;
 class QString;
@@ -60,6 +61,7 @@ private:
 
     kpColor m_newColor;
     QPixmap *m_oldPixmapPtr;
+    kpSelection m_oldSelection;
 };
 
 
Index: tools/kptoolconverttoblackandwhite.cpp
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolconverttoblackandwhite.cpp,v
retrieving revision 1.5
diff -u -p -b -r1.5 kptoolconverttoblackandwhite.cpp
--- tools/kptoolconverttoblackandwhite.cpp	12 Jan 2004 09:24:59 -0000	1.5
+++ tools/kptoolconverttoblackandwhite.cpp	24 Feb 2004 05:18:55 -0000
@@ -89,10 +89,15 @@ void kpToolConvertToBlackAndWhiteCommand
 
     QApplication::setOverrideCursor (Qt::waitCursor);
     
+    if (m_actOnSelection)
+    {
+        m_oldSelection = *doc->selection ();
+        m_oldSelection.setPixmap (QPixmap ());
+    }
+
     m_oldPixmapPtr = new QPixmap ();
     *m_oldPixmapPtr = *doc->pixmap (m_actOnSelection);
 
-
     QPixmap newPixmap = kpPixmapFX::convertToBlackAndWhite (*m_oldPixmapPtr);
 
     doc->setPixmap (m_actOnSelection, newPixmap);
@@ -107,9 +112,16 @@ void kpToolConvertToBlackAndWhiteCommand
     if (!doc)
         return;
 
-
-    doc->setPixmap (m_actOnSelection, *m_oldPixmapPtr);
-
+    if (!m_actOnSelection)
+    {
+        doc->setPixmap (*m_oldPixmapPtr);
+    }
+    else
+    {
+        kpSelection sel = m_oldSelection;
+        sel.setPixmap (*m_oldPixmapPtr);
+        doc->setSelection (sel);
+    }
 
     delete m_oldPixmapPtr;
     m_oldPixmapPtr = 0;
Index: tools/kptoolconverttoblackandwhite.h
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolconverttoblackandwhite.h,v
retrieving revision 1.3
diff -u -p -b -r1.3 kptoolconverttoblackandwhite.h
--- tools/kptoolconverttoblackandwhite.h	12 Jan 2004 09:24:59 -0000	1.3
+++ tools/kptoolconverttoblackandwhite.h	24 Feb 2004 05:18:55 -0000
@@ -31,6 +31,8 @@
 
 #include <kcommand.h>
 
+#include <kpselection.h>
+
 class QPixmap;
 class QString;
 
@@ -57,6 +59,7 @@ private:
     kpMainWindow *m_mainWindow;
 
     QPixmap *m_oldPixmapPtr;
+    kpSelection m_oldSelection;
 };
 
 #endif  // __kptoolconverttoblackandwhite_h__
Index: tools/kptoolconverttograyscale.cpp
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolconverttograyscale.cpp,v
retrieving revision 1.6
diff -u -p -b -r1.6 kptoolconverttograyscale.cpp
--- tools/kptoolconverttograyscale.cpp	2 Feb 2004 03:00:37 -0000	1.6
+++ tools/kptoolconverttograyscale.cpp	24 Feb 2004 05:18:55 -0000
@@ -80,6 +80,12 @@ void kpToolConvertToGrayscaleCommand::ex
 
     QApplication::setOverrideCursor (Qt::waitCursor);
     
+    if (m_actOnSelection)
+    {
+        m_oldSelection = *doc->selection ();
+        m_oldSelection.setPixmap (QPixmap ());
+    }
+
     m_oldPixmapPtr = new QPixmap ();
     *m_oldPixmapPtr = *doc->pixmap (m_actOnSelection);
 
@@ -97,7 +103,16 @@ void kpToolConvertToGrayscaleCommand::un
     if (!doc)
         return;
 
-    doc->setPixmap (m_actOnSelection, *m_oldPixmapPtr);
+    if (!m_actOnSelection)
+    {
+        doc->setPixmap (*m_oldPixmapPtr);
+    }
+    else
+    {
+        kpSelection sel = m_oldSelection;
+        sel.setPixmap (*m_oldPixmapPtr);
+        doc->setSelection (sel);
+    }
 
     delete m_oldPixmapPtr;
     m_oldPixmapPtr = 0;
Index: tools/kptoolconverttograyscale.h
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolconverttograyscale.h,v
retrieving revision 1.3
diff -u -p -b -r1.3 kptoolconverttograyscale.h
--- tools/kptoolconverttograyscale.h	12 Jan 2004 09:24:59 -0000	1.3
+++ tools/kptoolconverttograyscale.h	24 Feb 2004 05:18:55 -0000
@@ -30,6 +30,7 @@
 #define __kptoolconverttograyscale_h__
 
 #include <kcommand.h>
+#include <kpselection.h>
 
 class QPixmap;
 class QString;
@@ -55,6 +56,7 @@ private:
     bool m_actOnSelection;
     kpMainWindow *m_mainWindow;
     QPixmap *m_oldPixmapPtr;
+    kpSelection m_oldSelection;
 };
 
 #endif  // __kptoolconverttograyscale_h__
Index: tools/kptoolinvertcolors.cpp
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolinvertcolors.cpp,v
retrieving revision 1.6
diff -u -p -b -r1.6 kptoolinvertcolors.cpp
--- tools/kptoolinvertcolors.cpp	2 Feb 2004 03:24:32 -0000	1.6
+++ tools/kptoolinvertcolors.cpp	24 Feb 2004 05:18:56 -0000
@@ -61,24 +61,38 @@ kpToolInvertColorsCommand::~kpToolInvert
 }
 
 
-// public virtual [base KCommand]
-void kpToolInvertColorsCommand::execute ()
+// private
+kpDocument *kpToolInvertColorsCommand::document () const
 {
-    invert ();
+    return m_mainWindow ? m_mainWindow->document () : 0;
 }
 
+
 // public virtual [base KCommand]
-void kpToolInvertColorsCommand::unexecute ()
+void kpToolInvertColorsCommand::execute ()
 {
-    // symmetric operation
-    invert ();
-}
+    kpDocument *doc = document ();
+    if (!doc)
+        return;
 
+    QApplication::setOverrideCursor (Qt::waitCursor);
 
-// private
-void kpToolInvertColorsCommand::invert ()
+    if (m_actOnSelection)
+    {
+        m_oldSelection = *doc->selection ();
+        m_oldSelection.setPixmap (QPixmap ());
+    }
+
+    QPixmap newPixmap = kpPixmapFX::invertColors (*doc->pixmap (m_actOnSelection));
+    doc->setPixmap (m_actOnSelection, newPixmap);
+
+    QApplication::restoreOverrideCursor ();
+}
+
+// public virtual [base KCommand]
+void kpToolInvertColorsCommand::unexecute ()
 {
-    kpDocument *doc = m_mainWindow ? m_mainWindow->document () : 0;
+    kpDocument *doc = document ();
     if (!doc)
         return;
 
@@ -86,7 +100,16 @@ void kpToolInvertColorsCommand::invert (
     
     QPixmap newPixmap = kpPixmapFX::invertColors (*doc->pixmap (m_actOnSelection));
 
-    doc->setPixmap (m_actOnSelection, newPixmap);
+    if (!m_actOnSelection)
+    {
+        doc->setPixmap (newPixmap);
+    }
+    else
+    {
+        kpSelection sel = m_oldSelection;
+        m_oldSelection.setPixmap (newPixmap);
+        doc->setSelection (m_oldSelection);
+    }
 
     QApplication::restoreOverrideCursor ();
 }
Index: tools/kptoolinvertcolors.h
===================================================================
RCS file: /home/kde/kdenonbeta/kolourpaint/tools/kptoolinvertcolors.h,v
retrieving revision 1.3
diff -u -p -b -r1.3 kptoolinvertcolors.h
--- tools/kptoolinvertcolors.h	12 Jan 2004 09:24:59 -0000	1.3
+++ tools/kptoolinvertcolors.h	24 Feb 2004 05:18:56 -0000
@@ -31,6 +31,8 @@
 
 #include <kcommand.h>
 
+#include <kpselection.h>
+
 class kpMainWindow;
 
 class kpToolInvertColorsCommand : public KCommand
@@ -41,14 +43,17 @@ public:
     virtual QString name () const;
     virtual ~kpToolInvertColorsCommand ();
 
+private:
+    kpDocument *document () const;
+
+public:
     virtual void execute ();
     virtual void unexecute ();
 
 private:
-    void invert ();
-
     bool m_actOnSelection;
     kpMainWindow *m_mainWindow;
+    kpSelection m_oldSelection;
 };
 
 #endif  // __kptoolinvertcolors_h__
